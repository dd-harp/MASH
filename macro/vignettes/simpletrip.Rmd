---
title: "Simple Trip Movement"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simple Trip Movement}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(macro)
```

## Stochastic Model

### Master Equations

For verification consider the simplest system possible, where there are two patches $k=2$, and one resident of each patch. Then the state space has 4 unique states $\mathcal{S}:=\{S_{1},S_{2},S_{3},S_{4}\}$ where:

$$
S_{1} = (N_{11}=1,N_{12}=0,N_{21}=1,N_{22}=0) \\
S_{2} = (N_{11}=0,N_{12}=1,N_{21}=1,N_{22}=0) \\
S_{3} = (N_{11}=1,N_{12}=0,N_{21}=0,N_{22}=1) \\
S_{4} = (N_{11}=0,N_{12}=1,N_{21}=0,N_{22}=1)
$$

In this set up, $S_{1}$ is the state where the resident of patch 1 is at home but resident of patch 2 is away. $S_{2}$ is where neither is home. $S_{3}$ is where both are home. $S_{4}$ is where the resident of patch 1 is away but resident of patch 2 is home.

We can heuristically derive the master equations to describe this stochastic model by remembering that as $dt\rightarrow 0$ only single particle jumps are allowed.

$$
\frac{d}{dt}P(S_{1}) = -(\phi_{12} + \tau_{21})P(S_{1}) + \tau_{12}P(S_{2}) + \phi_{21}P(S_{3}) \\
\frac{d}{dt}P(S_{2}) = -(\tau_{12} + \tau_{21})P(S_{2}) + \phi_{12}P(S_{1}) + \phi_{21}P(S_{4}) \\
\frac{d}{dt}P(S_{3}) = -(\phi_{12} + \phi_{21})P(S_{3}) + \tau{12}P(S_{4}) + \tau_{21}P(S_{1}) \\
\frac{d}{dt}P(S_{4}) = -(\tau_{12} + \phi_{21})P(S_{4}) + \phi_{12}P(S_{3}) + \tau_{21}P(S_{2})
$$

The master equations are useful because we can use them to verify that the stochastic simulation is behaving correctly, they give us all information available about the stochastic system.

```{r, echo=FALSE, fig.cap="CTMC State Transition Diagram", out.width = "60%", fig.align='center'}
knitr::include_graphics("simpletrip_Q.png")
```

Using the master equations we can make the generator matrix $\mathbf{Q}$ of the system.

$$
\mathbf{Q}=\begin{vmatrix}
(\phi_{12}+\tau_{21}) & \phi_{12}  & \tau_{21}  & 0 \\
\tau_{12} & (\tau_{12}+\tau_{21})  & 0  & \tau_{21} \\
\phi_{21} & 0  & (\phi_{21}+\phi_{12})  & \phi_{12} \\
0 & \phi_{21}  & \tau_{12}  & (\phi_{21}+\tau_{12})
\end{vmatrix}
$$

To find the stationary distribution of this system given by the row vector $\pi$ we solve the linear system of equations $\pi\mathbf{Q}=0$ with the additional constraint that $\sum_{k}\pi_{k}=1$. Carrying out the calculation gives the following stationary probability vector:

$$
\pi_{1} = \frac{\phi_{21}\tau_{12}}{(\phi_{12}+\tau_{12})(\phi_{21}+\tau_{21})} \\
\pi_{2} = \frac{\phi_{12}\phi_{21}}{(\phi_{12}+\tau_{12})(\phi_{21}+\tau_{21})} \\
\pi_{3} = \frac{\tau_{12}\tau_{21}}{(\phi_{12}+\tau_{12})(\phi_{21}+\tau_{21})} \\
\pi_{4} = \frac{\phi_{12}\tau_{21}}{(\phi_{12}+\tau_{12})(\phi_{21}+\tau_{21})}
$$
